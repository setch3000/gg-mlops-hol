{
    "AWSTemplateFormatVersion" : "2010-09-09",
    "Description" : "AWS CloudFormation template for an GGv2 MLOps WS.",
    "Resources" : {
        "GGV2WSTokenExchangeRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
            "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                {
                    "Effect": "Allow",
                    "Principal": {
                    "Service": "credentials.iot.amazonaws.com"
                    },
                    "Action": "sts:AssumeRole"
                }
                ]
            },
            "Path": "/"
            }
        },
         "GGV2WSTokenExchangeAccess" : {
            "Type" : "AWS::IAM::Policy",
            "Properties" : {
                "PolicyName" : {"Fn::Join": ["", ["GGV2WSTokenExchangeAccess-", {"Ref": "AWS::Region"} ]]},
                "PolicyDocument" : {
                    "Version": "2012-10-17",
                    "Statement": [
                      {
                        "Effect": "Allow",
                        "Action": [
                          "iot:DescribeCertificate",
                          "logs:CreateLogGroup",
                          "logs:CreateLogStream",
                          "logs:PutLogEvents",
                          "logs:DescribeLogStreams",
                          "iot:Connect",
                          "iot:Publish",
                          "iot:Subscribe",
                          "iot:Receive",
                          "s3:GetBucketLocation"
                        ],
                        "Resource": "*"
                      }
                    ]
                  },
                "Roles" : [ { "Ref" : "GGV2WSTokenExchangeRole" } ]
            }
          },

          "GGV2WSIoTThingPolicy": {
            "Type": "AWS::IoT::Policy",
            "Properties": {
               "PolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": [
                      "iot:Publish",
                      "iot:Subscribe",
                      "iot:Receive",
                      "iot:Connect",
                      "greengrass:*"
                    ],
                    "Resource": [
                      "*"
                    ]
                  }
                ]
              }
            }
         },

         "GGV2WSFleetProvisioningRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
            "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": {
                      "Service": "iot.amazonaws.com"
                    },
                    "Action": "sts:AssumeRole"
                  }
                ]
              },
            "Path": "/",
            "ManagedPolicyArns" : [ "arn:aws:iam::aws:policy/service-role/AWSIoTThingsRegistration" ]
            }
        }
    },
  
    "Outputs" : {
      "GGV2WSTokenExchangeRole" : {
        "Description" : "Arn of the IAM Role for AWS IoT fleet provisioning for GGv2",
        "Value" : { "Fn::GetAtt" : ["GGV2WSTokenExchangeRole", "Arn"] }
      },
      "GGV2WSTokenExchangeAccess" : {
        "Description" : "Name of the IAM policy for AWS IoT fleet provisioning for GGv2",
        "Value" : { "Fn::GetAtt" : ["GGV2WSTokenExchangeAccess", "Arn"] }
      },
      "CreateRoleRliasCommand" : {
        "Description" : "create-role-alias command",
        "Value" : { "Fn::Join" : ["", ["aws iot create-role-alias --role-alias GGV2WSTokenExchangeRoleAlias --role-arn", { "Fn::GetAtt" : ["GGV2WSTokenExchangeRole", "Arn"]}]] }
      },
      "GGV2WSIoTThingPolicy" : {
        "Description" : "Name of the IoT policy for AWS IoT fleet provisioning",
        "Value" : { "Ref": "GGV2WSIoTThingPolicy" }
      },
      "GGV2WSFleetProvisioningRole" : {
        "Description" : "Name of the IAM Role for AWS IoT fleet provisioning",
        "Value" : { "Ref": "GGV2WSFleetProvisioningRole" }
      }
    }
  }
  